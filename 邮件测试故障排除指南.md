# WeRead Challenge 邮件测试故障排除指南

## 问题现象
- `test-email-authcode.js` 测试成功
- `test-email.ps1` 测试失败

## 问题分析

### 根本原因
PowerShell脚本中设置的环境变量无法正确传递给Node.js子进程，导致Node.js脚本无法读取到正确的邮件配置。

### 技术原因
1. **环境变量作用域问题**：PowerShell中设置的环境变量只在当前PowerShell会话中有效
2. **子进程继承问题**：Node.js子进程可能无法继承PowerShell设置的环境变量
3. **变量传递机制**：不同的进程启动方式对环境变量的处理不同

## 解决方案

### 方案一：使用简化测试脚本（推荐）
使用 `test-email-simple.ps1`，该脚本直接在JavaScript代码中包含配置值，避免环境变量传递问题。

```powershell
# 运行简化测试脚本
.\test-email-simple.ps1
```

**优势：**
- ✅ 避免环境变量传递问题
- ✅ 配置直接嵌入，更可靠
- ✅ 详细的错误诊断信息
- ✅ 彩色输出，易于阅读

### 方案二：修复原始测试脚本
已修复的 `test-email.ps1` 使用PowerShell变量替换来直接生成JavaScript代码。

```powershell
# 运行修复后的测试脚本
.\test-email.ps1
```

### 方案三：直接使用Node.js脚本
如果您有现成的 `test-email-authcode.js`，可以直接使用：

```bash
node test-email-authcode.js
```

## 测试步骤

### 1. 首选方案：简化测试
```powershell
# 右键点击 test-email-simple.ps1 → "使用PowerShell运行"
# 或在PowerShell中执行：
.\test-email-simple.ps1
```

### 2. 备选方案：修复后的原始脚本
```powershell
.\test-email.ps1
```

### 3. 对比测试
如果两个脚本结果不同，说明环境变量传递确实存在问题。

## 预期结果

### 成功的输出示例
```
✅ SMTP连接验证成功
✅ 测试邮件发送成功!
🎉 邮件测试完成！请检查您的邮箱。
```

### 失败的输出示例
```
❌ SMTP连接验证失败: connect ECONNREFUSED
❌ 测试邮件发送失败: Invalid login
```

## 常见错误及解决方案

### 1. SMTP连接失败
**错误信息：** `connect ECONNREFUSED` 或 `connect ETIMEDOUT`

**解决方案：**
- 检查网络连接
- 确认SMTP服务器地址：`smtp.whut.edu.cn`
- 确认端口：587 (TLS) 或 465 (SSL)
- 检查防火墙设置

### 2. 认证失败
**错误信息：** `Invalid login` 或 `Authentication failed`

**解决方案：**
- 确认邮箱用户名：`322422@whut.edu.cn`
- 确认密码：`Vm3Zgz6AtGJj9JFE`
- 检查是否需要启用"不太安全的应用访问"
- 考虑使用应用专用密码

### 3. 环境变量问题
**错误信息：** `undefined` 或空值

**解决方案：**
- 使用 `test-email-simple.ps1`（推荐）
- 或检查环境变量设置

### 4. Node.js或nodemailer问题
**错误信息：** `Cannot find module 'nodemailer'`

**解决方案：**
```bash
npm install nodemailer
```

## 华中科技大学邮箱特殊设置

### SMTP配置确认
```
服务器: smtp.whut.edu.cn
端口: 587 (推荐) 或 465
加密: TLS (587端口) 或 SSL (465端口)
```

### 可能需要的设置
1. **登录邮箱系统**
   - 访问华中科技大学邮箱网页版
   - 查找"设置" → "POP3/IMAP/SMTP"

2. **启用SMTP服务**
   - 确保SMTP服务已启用
   - 可能需要生成应用专用密码

3. **安全设置**
   - 可能需要启用"不太安全的应用访问"
   - 或使用OAuth2认证

## 调试技巧

### 1. 详细日志
两个测试脚本都包含详细的调试信息：
- SMTP连接验证
- 邮件发送过程
- 错误详情

### 2. 网络测试
```powershell
# 测试SMTP服务器连接
Test-NetConnection -ComputerName smtp.whut.edu.cn -Port 587
Test-NetConnection -ComputerName smtp.whut.edu.cn -Port 465
```

### 3. 手动验证
使用邮件客户端（如Outlook、Thunderbird）手动配置相同的SMTP设置进行验证。

## 下一步行动

### 如果测试成功
1. 确认收到测试邮件
2. 检查邮件是否在垃圾邮件文件夹
3. 继续设置每日任务计划程序

### 如果测试失败
1. 查看详细错误信息
2. 按照错误类型进行故障排除
3. 考虑联系华中科技大学IT支持

### 验证WeRead Challenge邮件功能
测试成功后，运行实际的WeRead Challenge程序验证邮件通知：
```powershell
.\run-simple.ps1
```

## 总结

使用 `test-email-simple.ps1` 是最可靠的测试方法，因为它避免了PowerShell环境变量传递的复杂性。如果这个脚本测试成功，说明邮件配置正确，WeRead Challenge的邮件功能应该能正常工作。
